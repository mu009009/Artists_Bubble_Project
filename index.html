<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="css/style.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/normalize.css" /><!--CSS RESET-->
    <link rel="stylesheet" type="text/css" href="css/reset.css"><!--演示页面样式，使用时可以不引用-->
    <link rel="stylesheet" type="text/css" href="css/jquery.sTags.css"><!--标签插件样式-->
    <link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.14.2/styles/monokai-sublime.min.css"><!--代码高亮样式-->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-queue.v3.min.js"></script>
    
    <script src="javascript/jquery-1.11.0.min.js" type="text/javascript"></script>
    <script src="https://cdn.bootcss.com/highlight.js/9.14.2/highlight.min.js"></script><!--代码高亮插件-->
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="javascript/jquery.sTags.js"></script>

    
    <script src="javascript/script.js"></script>
    <script src="javascript/menul_bubble.js"></script>
    <script src="javascript/1st_layer_menul_bubble.js"></script>
  <title>D3 Country Bubble Chart</title>
</head>
<body>
    
    <div class="container">
        
        <div id="inputDiv" style="width: 100%">
            <input type="text" class="sTags-input" id="DemoInput1" style="width: inherit">
        </div>

    <div id="controls">

    <!--   因为不会改所以留下的奇奇怪怪的玩意  -->
        <span>
            <label><input id="flags" type="radio" name="fill" value="flags" style="display: none"></label>
        </span>
        <div class = "col-4">
        </div>
        <div class="col-4">
            <div class="radio" style="float: left; text-align: center">
              <label>
                <input class="radioBut" type="radio" name="optionsRadios" id="optionsRadios1" value="option1" checked>
                  KeyWords
              </label>
            </div>
            <div class="radio">
              <label>
                <input class="radioBut" type="radio" name="optionsRadios" id="optionsRadios2" value="option2">
                 Theme
              </label>
            </div>
        </div>
        <div class="col-4">
        </div>

    </div>
        
    <div id='main_control' style="align-items: center; display: block; height: 50px">
        <div style="float: left; width: 5%">
            <button id="reset_btn" type="button" class="btn btn-primary" >Reset</button>
        </div>
        
        <div id="title_space" style="width: 90%; float:left; text-align: center; font-size: 24px">
        </div>
        
        <div style="float: right; width: 5%">
            <button id="search_btn" type="button" class="btn btn-primary" style="float: right">Search</button>
        </div>        
    </div>
        
    <div id="bubble-chart"></div>        
        
    <div id="country-info"></div>
    </div>

<script>
    
    var TagsData = [];
    var TagsID = 0;
    var SelectedData = [];
    var checkedOne = "optionsRadios1";
    var saveColorScale;
    
    radioListener();
    
    //窗口改变时刷新
    $( window ).resize(function() {
        location.reload();
    });
    
    d3.queue()
        .defer(d3.csv, "key_words_data.csv")
        .defer(d3.json,"artists_category.json")
        .await(createMenulBubbleChart);     
    
    //reset button function
    $('#reset_btn').on('click', function(event) {
        location.reload();
    });
    
    //the key search button function
    $('#search_btn').on('click', function(event) {
        //input the TagsData;
        var targetData = TagsData;
        //reset the whole visualization
        
        //choose the way to draw the artists circle
        switch(checkedOne){
            case "optionsRadios1":
                d3.queue()
                .defer(d3.csv, "Artists_Filter.csv")
                .await(refresh_new_bubbles);
                break;
            case "optionsRadios2":
                d3.queue()
                .defer(d3.csv, "Artists_Selected_Match_Data.csv")
                .await(refresh_new_bubbles);
                break;
        }
    });
    
    function matchString(targetData,artistsArray,mode, callback){
        
        var filterArtists = [];
        
        //match the artists with the TagsData;
        for(var i=0; i<artistsArray.length; i++){
            var matchingTime = 0;
            for(var j=0; j<targetData.length;j++){
                //split str, match only with keywords
                var ifmatch = false;
                if( mode == 1) {
                    var matchData = targetData[j].name.trim().split(/\s+/);
                    for(var z=0; z<matchData.length; z++){
                        if(artistsArray[i].Artists_Texts.search(matchData[z])!=-1){
                            filterArtists.push(artistsArray[i]);
                            filterArtists[filterArtists.length - 1].Group_Code = targetData[j].Group_Code;
                            ifmatch = true;
                            break;
                        }                    
                    }
                    // when match the string, break the keywords loop, run another artists Matching
                    if(ifmatch){
                        break;
                    }                    
                } else {
                    if((artistsArray[i].Artists_Texts.search(targetData[j].name))!=-1){
                        matchingTime += 1;
                        //用来控制层级筛选关系，现在只有一层的时候 matchingTime 为 1 即可出现结果，如果搜索层级增加，那么也需要增加该部分的数值
                        if(matchingTime >= 1){
                                filterArtists.push(artistsArray[i]);
                                break;
                            }
                        }
                    }
                }
            }
        
        if(callback){
            callback(filterArtists);
        }
        
    }
    
    function refresh_new_bubbles(error, data){
        
        var artistsArray = data;
        switch(checkedOne){
            case "optionsRadios1":
                matchString(TagsData,artistsArray,1,updatetheCircleMap);
                break;
            case "optionsRadios2":
                matchString(TagsData,artistsArray,0,updatetheCircleMap);
                break;
        }
    }
    
    function updatetheCircleMap(filterArtists){
        console.log('call back running');
        console.log(filterArtists);
        //remove current layout
        $('#bubble-chart').empty();
        $('#flags').attr('checked','checked');
        
        //draw new circle
        createArtistsBubble(null,filterArtists)
    }
    
    function radioListener() {
        d3.selectAll('.radioBut')
          .on("change", function() {
            var radioList = document.getElementsByClassName("radioBut");
            for(i=0;i<radioList.length;i++){
                if(radioList[i].checked){
                    checkedOne = radioList[i].id;
                    break;
                }
            }
            updatePainting(checkedOne)
          });
    }
    
    function updatePainting(currentMode){
        console.log(currentMode);
        switch(currentMode){
            case 'optionsRadios1': 
                $('#bubble-chart').empty();
                d3.queue()
                    .defer(d3.csv, "key_words_data.csv")
                    .defer(d3.json,"artists_category.json")
                    .await(createMenulBubbleChart);
                break;
            case 'optionsRadios2':
                $('#bubble-chart').empty();
                d3.queue()
                    .defer(d3.csv, "selected_key_words_data.csv")
                    .defer(d3.json,"race_series.json")
                    .await(create1st_MenulBubble);
                break;
        }
    }
    
    //write some comments help github

</script>

</body>
</html>
